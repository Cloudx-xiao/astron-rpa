const e={wait:async e=>new Promise(t=>{setTimeout(t,1e3*e)}),generateUUID(){let e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const a=(e+16*Math.random())%16|Math.trunc(e/16);return e=Math.floor(e/16),("x"===t?a:3&a|8).toString(16)})},getNavigatorUserAgent(){const e=/Firefox/.test(navigator.userAgent),t=/Edg/.test(navigator.userAgent),a=/OPR/.test(navigator.userAgent);return e?"Firefox":t?"Edge":a?"Opera":"Chrome"},removeUrlParams:e=>e.replace(/\?.*$/,""),isEndWithSlash:e=>e.endsWith?e.endsWith("/"):"/"===e.substr(-1),stringToRegex(e){let t=e,a="";const r=e.lastIndexOf("/");e.startsWith("/")&&r>0&&(t=e.slice(1,r),t.startsWith("^")&&t.endsWith("$")&&(t=t.slice(1,-1)),(t.includes("\\d")||t.includes("\\w")||t.includes("\\s")||t.includes("\\b")||t.includes("\\.")||t.includes("\\*")||t.includes("\\?")||t.includes("\\+")||t.includes("\\{")||t.includes("\\}")||t.includes("\\[")||t.includes("\\]"))&&(t=t.replace(/\\/g,"\\")),a=e.slice(r+1));try{return new RegExp(t,a)}catch(n){throw new Error("Invalid regular expression pattern")}},isSupportProtocal:e=>!!(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("ftp://")||e.startsWith("file://")),isNumberStartString:e=>/^\d/.test(e),isNumberString:e=>/\d/.test(e),isSpecialCharacter(e){return!!this.isNumberStartString(e)||!!/[~`!@#$%^&*()+\-={}\\[\]|\:;"'<>,.?/\\（）￥！、；：“”‘’【】《》，。？、]/.test(e)},success:(e,t="success")=>({code:"0000",data:e,msg:t}),fail:(e="failed",t="5001")=>({code:t,msg:e}),result:(e,t="success",a="0000")=>({code:a,data:e,msg:t})},t={getCookie:t=>new Promise(a=>{t.url||a(e.fail("缺少url字段！")),t.name?chrome.cookies.get(t,t=>{a(e.success(t))}):chrome.cookies.getAll({url:t.url},t=>{a(e.success(t))})}),removeCookie:t=>new Promise(a=>{t.url||a(e.fail("缺少url字段！")),t.name||a(e.fail("缺少name字段！")),chrome.cookies.remove(t,()=>{a(e.success("删除成功"))})}),setCookies:t=>new Promise(a=>{if(Array.isArray(t)){const r=t.map(t=>new Promise(r=>{const{name:n,url:s,path:i,value:o,domain:c,expirationDate:l}=t;s||a(e.fail("缺少url字段！")),n&&o||a(e.fail("缺少必填字段name, value！"));const d={name:n,value:o,url:s,domain:c,expirationDate:l,path:i};chrome.cookies.set(d,()=>{r(!0)})}));Promise.all(r).then(t=>{a(e.success("设置成功"))})}else t.url||a(e.fail("缺少url字段！")),t.name&&t.value||a(e.fail("缺少必填字段name, value！")),chrome.cookies.set(t,()=>{a(e.success("设置成功"))})})};class a{constructor(e,t,a){if(this.produceType=a,"table"===a&&(this.data={...e,produceType:a,values:t}),"similar"===a){const r={...e,value:t};this.data={produceType:a,values:[r]}}}getTable(){return this.data}isSimilarDataType(){return"similar"===this.produceType}}const r=new class{constructor(){this.dbName="iflyrpa-ext-log",this.storeName="logs",this.maxRecords=5e3,this.maxSizeMB=5,this.db=null,this.batchInterval=5e3,this.maxBatchSize=50,this.pendingLogs=[],this.logCache=[],this.cacheSize=100,this.initDB().then(()=>{this.startBatchProcessor()})}initDB(){return new Promise((e,t)=>{const a=indexedDB.open(this.dbName,1);a.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(this.storeName)){const e=t.createObjectStore(this.storeName,{keyPath:"id",autoIncrement:!0});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("source","source",{unique:!1}),e.createIndex("level","level",{unique:!1})}},a.onsuccess=t=>{this.db=t.target.result,this.cleanup().finally(()=>e(this.db))},a.onerror=e=>{console.error("IndexedDB error:",e.target.error),t(e.target.error)}})}startBatchProcessor(){this.batchTimer=setInterval(()=>{this.flushBatch().catch(e=>{console.error("Batch flush error:",e)})},this.batchInterval),window.addEventListener("beforeunload",()=>{this.flushBatchSync()})}async addLog(e){this.db||await this.initDB();const t={...{timestamp:(new Date).toLocaleString(),level:"info",source:"unknown",message:""},...e};return this.pendingLogs.push(t),this.addToCache(t),this.pendingLogs.length>=this.maxBatchSize&&await this.flushBatch(),Promise.resolve()}addToCache(e){this.logCache.unshift(e),this.logCache.length>this.cacheSize&&this.logCache.pop()}async flushBatch(){if(0===this.pendingLogs.length||!this.db)return;const e=[...this.pendingLogs];this.pendingLogs=[];try{await this.saveBatchToDB(e),await this.cleanup()}catch(t){throw console.error("Failed to save batch:",t),this.pendingLogs.unshift(...e),t}}flushBatchSync(){if(0===this.pendingLogs.length||!this.db)return;const e=[...this.pendingLogs];return this.pendingLogs=[],new Promise(t=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),r=e.map(e=>new Promise(t=>{const r=a.add(e);r.onsuccess=t,r.onerror=()=>t()}));Promise.all(r).then(()=>{this.cleanup().finally(t)})})}saveBatchToDB(e){return new Promise((t,a)=>{const r=this.db.transaction([this.storeName],"readwrite"),n=r.objectStore(this.storeName);let s=!1;e.forEach(e=>{n.add(e).onerror=()=>{s=!0}}),r.oncomplete=()=>{s?a(new Error("Some logs failed to save")):t()},r.onerror=e=>{a(e.target.error)}})}async cleanup(){const e=await this.getLogCount(),t=await this.estimateSizeMB();let a=!1,r=0;if(e>.8*this.maxRecords&&(r=Math.max(r,e-this.maxRecords),a=!0),t>.8*this.maxSizeMB){const n=t/e,s=Math.ceil((t-.8*this.maxSizeMB)/n);r=Math.max(r,s),a=!0}a&&await this.trimRecords(r)}async getLogCount(){const e=this.pendingLogs.length;return await new Promise((e,t)=>{if(!this.db)return void e(0);const a=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).count();a.onsuccess=()=>e(a.result),a.onerror=()=>e(0)})+e}estimateSizeMB(){return new Promise(e=>{navigator.storage&&navigator.storage.estimate?navigator.storage.estimate().then(t=>{const a=(t.usage/1048576).toFixed(2);e(parseFloat(a))}).catch(()=>e(0)):e(0)})}async trimRecords(e){if(e<=0)return 0;let t=0;for(;t<e;){const a=Math.min(100,e-t),r=await this.deleteBatch(a);if(t+=r,r<a)break}return t}deleteBatch(e){return new Promise((t,a)=>{const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("timestamp").openCursor();let n=0;const s=[];r.onsuccess=a=>{const r=a.target.result;r&&n<e?(s.push(new Promise(e=>{const t=r.delete();t.onsuccess=()=>{n++,e()},t.onerror=e})),r.continue()):Promise.all(s).then(()=>{t(n)})},r.onerror=e=>{a(e.target.error)}})}async getLogs({source:e,level:t,limit:a=50,since:r}={}){let n=this.filterCache({source:e,level:t,since:r});if(n.length>=a)return n.slice(0,a);const s=a-n.length,i=await this.queryDB({source:e,level:t,limit:s,since:r});return[...n,...i].sort((e,t)=>t.timestamp-e.timestamp).slice(0,a)}filterCache({source:e,level:t,since:a}){return this.logCache.filter(r=>(!e||r.source===e)&&((!t||r.level===t)&&!(a&&r.timestamp<a)))}queryDB({source:e,level:t,limit:a,since:r}){return new Promise((n,s)=>{if(!this.db)return void n([]);const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName);let o;if(e&&t){o=i.index("source").openCursor(IDBKeyRange.only(e))}else if(e){o=i.index("source").openCursor(IDBKeyRange.only(e))}else if(t){o=i.index("level").openCursor(IDBKeyRange.only(t))}else if(r){o=i.index("timestamp").openCursor(IDBKeyRange.lowerBound(r))}else{o=i.index("timestamp").openCursor(null,"prev")}const c=[];let l=0;o.onsuccess=s=>{const i=s.target.result;if(i){const s=i.value;let o=!0;e&&t&&s.source===e&&s.level!==t&&(o=!1),r&&s.timestamp<r&&(o=!1),o&&(c.push(s),l++),!a||l<a?i.continue():n(c)}else n(c)},o.onerror=e=>{s(e.target.error)}})}async clearLogs(){if(this.pendingLogs=[],this.logCache=[],this.db)return new Promise((e,t)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();a.onsuccess=()=>e(),a.onerror=e=>t(e.target.error)})}};window.addEventListener("beforeunload",()=>{r.flushBatchSync()});const backgroundLog_info=e=>{r.addLog({level:"info",source:"background",message:e})},contentLog_info=e=>{r.addLog({level:"info",source:"content",message:e})};function getSimilarElement(e,t){if(!function(e,t){const{xpath:a,cssSelector:r,pathDirs:n}=e,{xpath:s,cssSelector:i,pathDirs:o}=t,c=a.split("/"),l=s.split("/"),d=r.split(">"),u=i.split(">");if(e.url!==t.url)return!1;if(c.length!==l.length)return!1;if(c.length===l.length)for(let m=0;m<c.length;m++){const e=/\[(\d+)\]/,t=c[m].replace(e,""),a=l[m].replace(e,"");if(t!==a&&"*"!==t&&"*"!==a)return!1}if(d.length!==u.length)return!1;if(n.length!==o.length)return!1;return!0}(e,t))return!1;const a=function(e,t){if(e===t)return e;const a=e.split("/"),r=t.split("/");for(let s=0;s<a.length;s++)if(a[s]!==r[s]){const e=/\[(\d+)\]/,t=a[s].match(e);t&&(a[s]=a[s].replace(t[0],""))}let n=a.join("/");return n}(e.xpath,t.xpath);backgroundLog_info(`generateSimilarXapth xpath: ${a}`);const r=function(e,t){if(e===t)return e;const a=e.split(">"),r=t.split(">");for(let n=0;n<a.length;n++)a[n]!==r[n]&&a[n].indexOf(":nth-child")>-1&&(a[n]=a[n].split(":nth-child")[0]),a[n]!==r[n]&&a[n].indexOf(".")>-1&&(a[n]=a[n].split(".")[0]),a[n]!==r[n]&&a[n].indexOf("#")>-1&&(a[n]=a[n].split("#")[0]);return a.join(">")}(e.cssSelector,t.cssSelector);backgroundLog_info(`generateSimilarSelector cssSelector: ${r}`);const n=function(e,t){for(let a=e.length-1;a>=0;a--){const r=e[a],n=t[a];r.attrs.forEach(e=>{e.checked=!1;const t=n.attrs.find(t=>t.name===e.name);t||(e.value=""),t&&"id"===t.name&&e.value===t.value&&""!==e.value&&(e.checked=!0),t&&"index"===t.name&&""!==e.value&&String(e.value)===String(t.value)&&(e.checked=!0),t&&"innertext"===t.name&&(e.checked=!1,e.value="")});r.attrs.some(e=>"id"===e.name&&e.checked)&&r.attrs.forEach(e=>{"id"!==e.name&&(e.checked=!1)})}return e}(e.pathDirs,t.pathDirs);backgroundLog_info(`generateSimilarPathDirs pathDirs: ${JSON.stringify(n)}`);return{...e,xpath:a,cssSelector:r,pathDirs:n}}const n=devicePixelRatio||1,s="jpeg";async function captureFullPage(t){let a;if("Firefox"===e.getNavigatorUserAgent())return a=await function(e){return new Promise(t=>{chrome.tabs.sendMessage(e.id,{key:"fullPageRect",data:{}},{frameId:0},function(a){browser.tabs.captureTab(e.id,{format:s,quality:92,rect:a}).then(e=>{t(e)})})})}(t),a;await attach(t.id,null,t),await enablePage(t.id),await setBg(t.id,{color:{r:255,g:255,b:255,a:1}});const{cssContentSize:{width:r,height:i}}=await(o=t.id,new Promise(e=>{chrome.debugger.sendCommand({tabId:o},"Page.getLayoutMetrics",{},e)}));var o;return await function(e,{height:t,width:a}){return new Promise(r=>{chrome.debugger.sendCommand({tabId:e},"Emulation.setDeviceMetricsOverride",{height:t,width:a,deviceScaleFactor:n,mobile:!1},r)})}(t.id,{height:i,width:r}),await sleep(500),a=await screenshot(t.id,{x:0,y:0,width:r,height:i}),await sleep(500),await clearSize(t.id),await detach(t.id),a}function clearSize(e){return new Promise(t=>{chrome.debugger.sendCommand({tabId:e},"Emulation.clearDeviceMetricsOverride",t)})}function screenshot(e,t){return new Promise((a,r)=>{chrome.debugger.sendCommand({tabId:e},"Page.captureScreenshot",{format:s,fromSurface:!0,quality:92,clip:{...t,scale:n}},e=>{if(chrome.runtime.lastError)r(chrome.runtime.lastError);else{let t=`data:image/${s};base64,${e.data}`;a(t)}})})}function setBg(e,t){return new Promise(a=>{chrome.debugger.sendCommand({tabId:e},"Emulation.setDefaultBackgroundColorOverride",t,a)})}function enablePage(e){return new Promise(t=>{chrome.debugger.sendCommand({tabId:e},"Page.enable",{},function(){t(e)})})}function attach(e,t,a){return new Promise((t,r)=>{"complete"==a.status&&chrome.debugger.attach({tabId:e},"1.0",()=>{chrome.runtime.lastError?r(chrome.runtime.lastError):t(a||{id:e})})})}function detach(e){return new Promise(t=>{chrome.debugger.detach({tabId:e},()=>{console.log("detach"),setTimeout(()=>{t(e)},3e3)})})}function sleep(e){return new Promise(t=>setTimeout(t,e))}async function captureArea(e,t){const a=await function(e){return new Promise(t=>{chrome.tabs.sendMessage(e.id,{key:"getDPR",data:{}},{frameId:0},function(e){"number"==typeof e.dpr?t(e.dpr):t(1)})})}(e);t={x:t.x/a,y:t.y/a,width:t.width/a,height:t.height/a},await attach(e.id,0,e),await enablePage(e.id),await setBg(e.id,{color:{r:255,g:255,b:255,a:1}}),await sleep(3e3);const r=await screenshot(e.id,t);return await clearSize(e.id),await detach(e.id),await sleep(1e3),r}const i={query:e=>new Promise(t=>{chrome.tabs.query(e,e=>{t(e)})}),create:e=>(e.url||(e.url="about:blank"),new Promise(t=>{chrome.tabs.create(e,e=>{t(e)})})),update:(e,t)=>new Promise(a=>{chrome.tabs.update(e,t,e=>{a(e)})}),get:e=>new Promise(t=>{chrome.tabs.get(e,e=>{t(e)})}),reload:()=>new Promise(e=>{i.getActiveTab().then(t=>{chrome.tabs.reload(t.id,{bypassCache:!0},()=>{e(!0)})})}),stopLoad:()=>new Promise(e=>{i.getActiveTab().then(t=>{i.sendTabMessage(t.id,{key:"stopLoad",data:{key:"stopLoad",data:{}}}).then(t=>{e(t)})})}),goForward:()=>new Promise(e=>{i.getActiveTab().then(t=>{chrome.tabs.goForward(t.id,()=>{e(!0)})})}),goBack:()=>new Promise(e=>{i.getActiveTab().then(t=>{chrome.tabs.goBack(t.id,()=>{e(!0)})})}),remove:e=>new Promise(t=>{chrome.tabs.remove(e,()=>{t(!0)})}),getZoom:e=>new Promise(t=>{chrome.tabs.getZoom(e,e=>{t(e)})}),executeScriptOnFrame:(e,t,a)=>new Promise((r,n)=>{const s={frameId:t,code:a,matchAboutBlank:!0};chrome.tabs.executeScript(e,s,s=>{console.log("executeScriptOnFrame:",t,a,s),backgroundLog_info(`executeScriptOnFrame: frameId: ${t}, code: ${a} result: ${JSON.stringify(s)}`),s&&null!==s[0]||(i.sendTabFrameMessage(e,window.contentJS,t).then(e=>{console.log(t," iframe 加载注入contentJS结果:",e)}),n(new Error("executeScriptOnFrame error"))),chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):Array.isArray(s)&&1==s.length?r(s[0]):n(new Error(`unknown error: fail to execute script on ${t}`))})}),getAllTabs:()=>new Promise(e=>{chrome.tabs.query({},t=>{e(t)})}),reloadAllTabs:()=>{i.getAllTabs().then(e=>{for(const t of e)t.url&&!t.url.startsWith("chrome://")&&chrome.tabs.reload(t.id)})},urlGetTab:t=>new Promise((a,r)=>{chrome.tabs.query({},n=>{const s=n.find(a=>e.isEndWithSlash(a.url)&&!e.isEndWithSlash(t)?a.url===t+"/":a.url===t);s?i.activeTargetTab(s.id).then(e=>{a(e)}):r(new Error("Tab not found"))})}),getTab:e=>new Promise((t,a)=>{i.getActiveTab().then(a=>{a.url===e?t(a):i.urlGetTab(e).then(e=>{t(e)},()=>{i.openTab(e).then(e=>{t(e)})})})}),getActiveTab:()=>new Promise(e=>{chrome.tabs.query({active:!0,currentWindow:!0},t=>{e(t[0])})}),activeTargetTab:e=>new Promise(t=>{chrome.tabs.update(e,{active:!0},e=>{t(e)})}),activeTargetTabByTabUrl:e=>new Promise(t=>{chrome.tabs.query({url:e},a=>{a&&a[0]?chrome.tabs.update(a[0].id,{active:!0,highlighted:!0,selected:!0},e=>{t(e)}):chrome.tabs.create({url:e},e=>{t(e)})})}),switchTab:(e,t,a)=>new Promise(r=>{a?i.activeTargetTab(a).then(e=>{r(e)}):chrome.tabs.query({url:e,title:t},e=>{e&&e[0]?i.activeTargetTab(e[0].id).then(e=>{r(e)}):r(null)})}),openTab:e=>new Promise(t=>{chrome.tabs.create({url:e},e=>{t(e)})}),closeTab:e=>new Promise(t=>{chrome.tabs.remove(e,()=>{t(!0)})}),excuteTabScript:(e,t)=>new Promise(a=>{chrome.tabs.executeScript(e,{code:t},e=>{a(e)})}),getAllFrames:t=>new Promise(a=>{chrome.webNavigation.getAllFrames({tabId:t},r=>{const n=r.filter(t=>e.isSupportProtocal(t.url)),s=n.map((e,a)=>i.executeScriptOnFrame(t,n[a].frameId,'window.handleSync({ key: "getFrameInfo", data: {} })').then(t=>{n[a]={...e,...t}}).catch(t=>{console.error(`Error executing script on frame ${e.frameId}:`,t)}));Promise.all(s).then(()=>a(n))})}),getExtFrames:e=>new Promise(t=>{chrome.webNavigation.getAllFrames({tabId:e},e=>{t(e)})}),sendTabFrameMessage:(e,t,a)=>new Promise(r=>{chrome.tabs.sendMessage(e,t,{frameId:a},e=>{r(e)})}),sendTabMessage:(e,t)=>new Promise(a=>{chrome.tabs.sendMessage(e,t,{},e=>{a(e)})}),sendMessage:e=>new Promise(t=>{i.getAllTabs().then(a=>{a.forEach(a=>{chrome.tabs.sendMessage(a.id,e,{},e=>{t(e)})})})}),getFramePosition:(e,t,a)=>new Promise(r=>{i.sendTabFrameMessage(e,{key:"getFramePosition",data:{url:a}},t).then(e=>{r(e)})}),getUrl:()=>new Promise(e=>{i.getActiveTab().then(t=>{e(t.url)})}),getTitle:()=>new Promise(e=>{i.getActiveTab().then(t=>{e(t.title)})}),captureScreen:()=>new Promise(e=>{i.getActiveTab().then(t=>{chrome.tabs.captureVisibleTab(t.windowId,{format:"jpeg",quality:80},t=>{e(t)})})}),capturePage:async()=>new Promise(e=>{i.getActiveTab().then(t=>{captureFullPage(t).then(t=>{e(t)})})}),captureElement:async e=>new Promise(t=>{i.getActiveTab().then(a=>{captureArea(a,e).then(e=>{t(e)})})}),resetZoom:e=>new Promise(t=>{chrome.tabs.setZoom(e,1,()=>{t(!0)})})},WindowControl_getCurrent=()=>new Promise(e=>{chrome.windows.getCurrent(null,t=>{e(t)})}),WindowControl_update=(e,t)=>new Promise(a=>{chrome.windows.update(e,t,e=>{a(e)})});function findFrameByUrl(e,t){return e.find(e=>e.url.includes(t))}function findFrameByXpath(e,t){const a=t.split("/$iframe$"),r=e.find(e=>0===e.frameId);return a.reduce((t,a)=>{const r=e.find(e=>e.iframeXpath===a&&e.parentFrameId===t.frameId);return t&&r},r)}function adjustRectPosition(e,t){e.x+=t.x,e.y+=t.y,e.left=e.x,e.top=e.y,e.right=e.x+e.width,e.bottom=e.y+e.height}async function findTabAndFrame(e){const{url:t,iframeXpath:a,isFrame:r,tabUrl:n}=e.data;let s=await i.getActiveTab();if(s||(s=await i.activeTargetTabByTabUrl(n)),r&&a){const e=await i.getAllFrames(s.id),r=a?findFrameByXpath(e,a):findFrameByUrl(e,t);return r?{tab:s,frameId:r.frameId}:{tab:s,frameId:-1}}return{tab:s,frameId:0}}window.activeElement=null;const o={version:"5.1.3",tabsHandler:()=>({async reloadTab(t){const a=await i.reload();return e.success(a)},async stopLoad(){const t=await i.stopLoad();return e.success(t)},async openNewTab(t){const a=await i.create(t.data);return e.success(a)},async closeTab(t){let a,{url:r,id:n}=t.data;if(n&&"number"!=typeof n){try{if(n=parseInt(n,10),isNaN(n))return e.fail("id 必须是数字")}catch(s){return e.fail("id 必须是数字")}return await i.remove(n),e.success(!0)}return r&&(a=await i.getTab(r)),a||(a=await i.getActiveTab()),a?(await i.remove(a.id),e.success(!0)):e.fail("tab not found")},async updateTab(t){const{url:a}=t.data;let r=await i.getActiveTab();return r?(await i.update(r.id,{url:a}),e.success(!0)):e.fail("tab not found")},async activeTab(t){const{url:a}=t.data,r=await i.getTab(a);return await i.activeTargetTab(r.id),e.success(!0)},async getActiveTab(){const t=await i.getActiveTab();return t?e.success(t):e.fail("未找到活动标签页")},async switchTab(t){let{url:a,title:r,id:n}=t.data;if(n&&"number"!=typeof n)try{if(n=parseInt(n,10),isNaN(n))return e.fail("id 必须是数字")}catch(o){return e.fail("id 必须是数字")}const s=await i.switchTab(a,r,n);return s?e.success(s):e.fail("未找到标签页")},async getAllTabs(){const t=await i.getAllTabs();return e.success(t)},async backward(t){const a=await i.goBack();return e.success(a)},async forward(t){const a=await i.goForward();return e.success(a)},async maxWindow(){const t=await WindowControl_getCurrent();if(await WindowControl_update(t.id,{state:"maximized"}))return e.success(!0);const{lastError:a}=chrome.runtime;return a?e.fail(a.message,"5003"):void 0},async minWindow(){const t=await WindowControl_getCurrent();if(await WindowControl_update(t.id,{state:"minimized"}))return e.success(!0);const{lastError:a}=chrome.runtime;return a?e.fail(a.message,"5003"):void 0},async executeScriptOnFrame(t){const{url:a,code:r}=t.data,n=await i.getActiveTab();if(!n)return e.fail("未找到活动标签页");const s=(await i.getAllFrames(n.id)).find(e=>e.url===a);if(s){const t=await i.executeScriptOnFrame(n.id,s.frameId,r);if(t)return e.success(t);{const{lastError:t}=chrome.runtime;if(t)return e.fail(t.message,"5003")}}else{const t=await i.executeScriptOnFrame(n.id,0,r);if(t)return e.success(t);{const{lastError:t}=chrome.runtime;if(t)return e.fail(t.message,"5003")}}},async getTitle(){const t=await i.getTitle();return e.success(t)},async getUrl(){const t=await i.getUrl();return e.success(t)},async captureScreen(){const t=await i.captureScreen();if(t)return e.success(t)},async capturePage(){const t=await i.capturePage();if(t)return e.success(t)},async loadComplete(){const{lastError:t}=chrome.runtime,a=await i.getActiveTab();return a?t?e.fail(t.message,"5003"):"complete"===a.status?e.success(!0):e.success(!1):e.fail("未找到活动标签页")},async getFrames(){const t=await i.getActiveTab();if(!t)return e.fail("未找到活动标签页");return await i.getAllFrames(t.id)},async getExtFrames(){const t=await i.getActiveTab();if(!t)return e.fail("未找到活动标签页");return await i.getExtFrames(t.id)},async resetZoom(){const t=await i.getActiveTab();if(!t)return e.fail("未找到活动标签页");return await i.resetZoom(t.id)},async getTabId(){const t=await i.getActiveTab();return t?e.success(t.id):e.fail("未找到活动标签页")}}),elementHandler:()=>window.contentJS?{async getElement(t){let a=window.activeElement;if(a&&a.isFrame){const{x:r,y:n}=t.data;if(!r||!n)return e.success(a);const s=await async function(e,t){const a=await i.getActiveTab(),r=await i.getAllFrames(a.id);let n=JSON.parse(JSON.stringify(t)),s=r.find(e=>e.frameId===t.frameId);const o=[];for(;s;)o.unshift(s.frameId),s=r.find(e=>e.frameId===s.parentFrameId);const c=[];for(let l=0;l<o.length;l++){const r=await i.executeScriptOnFrame(a.id,o[l],`window.handleSync({\n              key: "getIframeElement",\n              data: { x: ${e.x}, y: ${e.y} }\n            })`);if(r&&"0000"!==r.code)return t;c.push(r.data);const{nextPos:n}=r.data;e.x=n.x,e.y=n.y}if(c.length>0){const e=c[c.length-1],a=e.xpath===t.xpath,r=e.url===t.url;return a&&r||(c[c.length-1]=n),c.forEach((e,t)=>{n.iframeXpath=0===t?e.xpath:`${n.iframeXpath}/$iframe$${e.xpath}`,e.iframeContentRect&&(n.rect.x+=e.iframeContentRect.x,n.rect.y+=e.iframeContentRect.y)}),n.rect.left=n.rect.x,n.rect.top=n.rect.y,n.rect.right=n.rect.x+n.rect.width,n.rect.bottom=n.rect.y+n.rect.height,n.iframeXpath=n.iframeXpath.split("/$iframe$").slice(0,-1).join("/$iframe$"),n}return t}({x:r,y:n},a);return e.success(s)}return e.success(a)},async handleInContent(t){const{tab:a,frameId:r}=await findTabAndFrame(t);if(!a)return e.fail("未找到活动标签页");if(-1!==r){const n=await i.sendTabFrameMessage(a.id,t,r);return"0000"!==n.code?e.fail(n.msg,n.code):e.success(n.data)}return e.fail("未找到活动标签页")},async getElementPos(t){const{url:a,isFrame:r,iframeXpath:n,tabUrl:s}=t.data;let o=await i.getActiveTab();if(o||(o=await i.activeTargetTabByTabUrl(s)),!r){const a=await i.sendTabFrameMessage(o.id,t,0);return e.result(a.data,a.msg,a.code)}const c=await i.getAllFrames(o.id);let l=n?findFrameByXpath(c,n):findFrameByUrl(c,a);if(!l)return e.fail("未找到活动标签页");const d=function(e,t){const a=[];for(;t;)a.unshift(t),t=e.find(e=>e.frameId===t.parentFrameId);return a}(c,l),u=await async function(e,t){const a=t.slice(0,-1).map((a,r)=>{const n=t[r+1];return i.executeScriptOnFrame(e,a.frameId,`window.handleSync({\n        key: "getFramePosition",\n        data: {\n          ${n.iframeXpath?`iframeXpath: '${n.iframeXpath}',`:`url: '${n.url}',`}\n        }\n      })`)});return(await Promise.all(a)).reduce((e,t)=>(e.x+=t.x,e.y+=t.y,e),{x:0,y:0})}(o.id,d),m=await i.sendTabFrameMessage(o.id,t,l.frameId);return"0000"!==m.code?e.fail(m.msg,m.code):(function(e,t){Array.isArray(e)?e.forEach(e=>adjustRectPosition(e,t)):adjustRectPosition(e,t)}(m.data.rect,u),e.success(m.data))},checkElement:async e=>await o.elementHandler().getElementPos(e),async scrollIntoView(e){var t;if(null==(t=e.data)?void 0:t.openSourcePage){const t=await i.getActiveTab();t&&t.url===e.data.tabUrl||await i.openTab(e.data.url)}return await o.elementHandler().handleInContent(e)},async similarElement(t){var a;let r=window.activeElement;const{tabUrl:n}=t.data;let s=await i.getActiveTab();if(!s)return e.fail("未找到活动标签页");s.url!==n&&(s=await i.getTab(n));try{const n=getSimilarElement(t.data,r);if(n){const r=await o.elementHandler().handleInContent({...t,data:n});return n.similarCount=(null==(a=r.data)?void 0:a.similarCount)||0,e.success(n)}return e.fail("该元素不是相似元素","5002")}catch(c){return e.fail(c.toString(),"5003")}},elementFromSelect:async e=>await o.elementHandler().handleInContent(e),async elementIsRender(t){const{tab:a,frameId:r}=await findTabAndFrame(t);if(!a)return e.fail("未找到活动标签页");if(-1!==r){const n=await i.sendTabFrameMessage(a.id,t,r);return n?e.success(n.data):e.success(!1)}return e.success(!1)},async elementIsReady(t){const a=await i.getActiveTab(),{tab:r,frameId:n}=await findTabAndFrame(t);if(!r)return e.fail("未找到活动标签页");if(-1!==n){t.key="elementIsRender";const s=await i.sendTabFrameMessage(r.id,t,n),o="complete"===a.status;return s?e.success(s.data&&o):e.success(!1)}return e.success(!1)},async elementIsTable(t){t.data.xpath||(t.data=window.activeElement);const a={isTable:!!(await o.elementHandler().handleInContent(t)).data,...t.data};return e.success(a)},async tableDataBatch(e){var t;"xpath"in e.data||(e.data=window.activeElement);const r=await o.elementHandler().handleInContent(e),n=(null==(t=r.data)?void 0:t.values)||[];return{data:new a(r.data,n,"table").getTable()}},async tableColumnDataBatch(e){var t;"xpath"in e.data||(e.data=window.activeElement);const r=await o.elementHandler().handleInContent(e),n=(null==(t=r.data)?void 0:t.value)||[];return{data:new a(r.data,n,"similar").getTable()}},async similarBatch(e){var t;if("xpath"in e.data||(e.data=window.activeElement),"batchType"in e.data&&["similar","similarAdd"].includes(e.data.batchType)){const t=await o.elementHandler().similarElement(e);e.data=t.data}const r=await o.elementHandler().handleInContent(e),n=(null==(t=r.data)?void 0:t.value)||[];return{data:new a(r.data,n,"similar").getTable()}},async tableHeaderBatch(e){"xpath"in e.data||(e.data=window.activeElement);return{data:(await o.elementHandler().handleInContent(e)).data}},simalarListBatch:async e=>({data:(await o.elementHandler().handleInContent(e)).data}),highLightColumn:async e=>await o.elementHandler().handleInContent(e),async getBatchData(t){var a;if(null==(a=t.data)?void 0:a.openSourcePage){const e=await i.getActiveTab();e&&e.url===t.data.tabUrl||await i.openTab(t.data.tabUrl)}if(await e.wait(3),t.data&&"similar"===t.data.produceType){t.key="simalarListBatch";return await o.elementHandler().simalarListBatch(t)}t.key="tableDataBatch";return await o.elementHandler().tableDataBatch(t)},async elementShot(t){var a;t.key="scrollToTop",await o.elementHandler().scrollToTop(t),await o.tabsHandler().resetZoom(),t.key="getElementPos";const r=await o.elementHandler().getElementPos(t),{x:n,y:s,width:c,height:l}=null==(a=r.data)?void 0:a.rect,d=await i.captureElement({x:n,y:s,width:c,height:l});return e.success(d)},async scrollToTop(t){const a=await o.elementHandler().handleInContent(t);return e.success(a)},async getSimilarIterator(t){var a,r;t.key="elementFromSelect";const n=(null==(a=t.data)?void 0:a.index)||0,s=(null==(r=t.data)?void 0:r.count)||1,i=await o.elementHandler().elementFromSelect(t);if(i.data&&Array.isArray(i.data)){if(n<i.data.length){let t=[i.data[n]];return t=n+s<=i.data.length?i.data.slice(n,n+s):i.data.slice(n),t=t.map((e,t)=>(e.index+=t,{...e,similarCount:i.data.length})),e.success(t)}return e.fail("超出迭代范围")}return e.fail("未找到相似元素")},async getRelativeElement(t){const{relativeOptions:a}=t.data;if(!a)return e.fail("关联元素参数错误");return await o.elementHandler().handleInContent(t)},async generateElement(t){const a=await i.getActiveTab();if(!a)return e.fail("未找到活动标签页");return await i.sendTabFrameMessage(a.id,t,0)},clickElement:async e=>await o.elementHandler().handleInContent(e),inputElement:async e=>await o.elementHandler().handleInContent(e),getElementText:async e=>await o.elementHandler().handleInContent(e),getElementAttrs:async e=>await o.elementHandler().handleInContent(e),removeElementAttr:async e=>await o.elementHandler().handleInContent(e),setElementAttr:async e=>await o.elementHandler().handleInContent(e),getElementChecked:async e=>await o.elementHandler().handleInContent(e),setElementChecked:async e=>await o.elementHandler().handleInContent(e),getElementSelected:async e=>await o.elementHandler().handleInContent(e),setElementSelected:async e=>await o.elementHandler().handleInContent(e),getTableData:async e=>await o.elementHandler().handleInContent(e),scrollWindow:async e=>await o.elementHandler().handleInContent(e)}:e.fail("contentJS 未加载"),jsHandler:()=>({async runJS(t){const{tab:a,frameId:r}=await findTabAndFrame(t);if(!a)return e.fail("未找到活动标签页");if(-1!==r){return await i.sendTabFrameMessage(a.id,t,r)}return await i.sendTabMessage(a.id,t)}}),cookieHandler:()=>({...t}),otherHandler:()=>({currentExtension:()=>new Promise(e=>{chrome.management.getSelf(t=>{e(t)})})}),noHandler:()=>e.fail("暂不支持该功能，请升级插件！","5004")};window.Handlers=o,window.contentMessageHandler=function(e,t,a){if("element"===e.type&&t.tab){const a={tabTitle:t.tab.title,tabUrl:t.tab.url,isFrame:0!==t.frameId,frameId:t.frameId};window.activeElement={...e.data,...a}}return"log"===e.type&&contentLog_info(e.data),!0},window.bgHandler=async function(e){let t=null;const{key:a}=e,r=o;return["getElement","backgroundInject","contentInject"].includes(a)||backgroundLog_info(JSON.stringify(e)),r[a]?(t=await r[a](e),t):r.tabsHandler()[a]?(t=await r.tabsHandler()[a](e),t):r.elementHandler()[a]?(e.data&&"produceType"in e.data&&"similar"===e.data.produceType&&(e.data={...e.data,...e.data.values[0]}),t=await r.elementHandler()[a](e),t):r.jsHandler()[a]?(t=await r.jsHandler()[a](e),t):r.cookieHandler()[a]?(t=await r.cookieHandler()[a](e.data),t):r.otherHandler()[a]?(t=await r.otherHandler()[a](e.data),t):(t=r.noHandler(),t)};
